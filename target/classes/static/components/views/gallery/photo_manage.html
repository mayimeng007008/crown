<style>
	.layui-this{
		color: #1890ff !important;
	}
	
	.layui-input{
		width:30% !important;
	}
	
	.model-form-footer {
	    text-align: left;
	    margin-left: 40px;
	}
	
	.layui-table-tips-d {
    position: absolute;
    margin-left: -40px;
    margin-top: 10px;
    /* right: 0; */
    /* top: 0; */
    width: 20px;
    height: 20px;
    padding: 3px;
    cursor: pointer;
    background-color: #666;
    border-radius: 50%;
    color: #fff;
    display: none;
}
.layui-icon-close:before {
    content: "\1006";
    margin-left: 2px;
    }
    
    .abcd {
     position: absolute;
   /*  border: 1px red solid; */
    /* float: right; */
    width: 15%;
    height: 7%;
    margin-left: 82%;
    }
 .bbb {
   /*  border: 1px red solid; */
    position: absolute;
    width: 11%;
    height: 5%;
    margin-top: -31px;
    margin-left: 85.2%;
    display: none;
}
li{
    position: relative;
}
    .eee{
    width:100%;
      z-index:999;
    }
    #cancel-button{
    display:none;
        position: absolute;
         z-index:999;
    }
    #yes-botton{
         display: none;
    position: absolute;
    margin-left: 24%;
     z-index:999;
    }
    #delete-button{
     position: absolute;
      z-index:999;
    }
    #all-botton{
     display: none;
    position: absolute;
    margin-left: 60%;
     z-index:999;
    }
    #notAll-botton{
     display: none;
    position: absolute;
    margin-left: 60%;
     z-index:999;
    
    }
    #yesall-botton{
 	 display: none;
    position: absolute;
    margin-left: 24%;
     z-index:999;
    
    
    }
    #div-top{
    width:100%;
    height:5%;
    z-index:999;
    
    }
    #div-count{
     z-index:999;
      width: 10%;
    height: 4%;
    position: absolute;
  /*   border: 1px solid red; */
    }
  
</style>

<!-- Add mousewheel plugin (this is optional) -->
<script type="text/javascript" src="assets/libs/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="assets/libs/jquery.mousewheel-3.0.6.pack.js"></script>
<!-- Add fancyBox main JS and CSS files -->
<script type="text/javascript" src="assets/libs/source/jquery.fancybox.js?v=2.1.3"></script>
<link rel="stylesheet" type="text/css" href="assets/libs/source/jquery.fancybox.css?v=2.1.2" media="screen" />

<script type="text/javascript" src="https://cdn.bootcss.com/jszip/3.2.2/jszip.min.js"></script>

<div class="layui-card">
    <div class="layui-card-header">
        <h2 class="header-title">照片管理</h2>
        
        <span class="layui-breadcrumb pull-right">
          <a href="#!console">首页</a>
          <a><cite>照片管理</cite></a>
        </span>
    </div>
    
    <h4 style="margin-left: 48px;">对图片直播相册中的照片进行添加、删除、移动与标签管理。相册剩余上传时间：9天，到期后不可再往相册上传照片。</h4>
    <div class="layui-card-body">
       	<div class="layui-tab layui-tab-card">
		  <ul class="layui-tab-title">
		    <li class="layui-this">照片管理</li>
		    <li>活动基本信息</li>
		    <li>活动详情</li>
		  </ul>
		  
		  <div class="layui-tab-content" style="height: auto;padding: 0px;">
		  
		  	<div class="layui-tab-item layui-show">
				<div class="layui-form-item" style="padding:10px;">
		  	
			        <div id="wapperImg" style="osition: relative;overflow: auto;
		            clear: both;height: 630px">
		            <div id= "div-top">
		            <div id="div-count">
		           	<button id="count-botton" class="layui-btn layui-btn-sm layui-btn-normal">全部(<span id="span-count">0</span>)</button>
		            </div>
		            <div class="abcd">
			        	<button id="cancel-button" class="layui-btn layui-btn-sm layui-btn-normal">取消</button>
			        	<button id ="yes-botton" class="layui-btn layui-btn-sm layui-btn-danger ">删除</button>
			        	<button id ="yesall-botton" class="layui-btn layui-btn-sm layui-btn-danger ">删除</button>
			        	<button id ="all-botton" class="layui-btn layui-btn-sm layui-btn-danger ">全选</button>
			        	<button id ="notAll-botton" class="layui-btn layui-btn-sm layui-btn-danger ">取消全选</button>
			        	<button id="delete-button" class="layui-btn layui-btn-sm layui-btn-normal">删除照片</button>
			        	</div>
			        	</div>
			        	<ul class="flow-default" id="flowContent">
			        		<li style="display: inline-block; cursor: pointer" id="addImg">
			        			<img alt="照片管理" height="186px" width="186px" style="margin:5px;" 
			        			src="assets/images/default.png" class="layui-upload-img uploadImgPreView" >
			        		</li>
			        	<li></li> 
			        	
			        		
			        	</ul>
			       
			        </div>
			
			    </div>
			</div>
			
			
		    <div class="layui-tab-item">
		    	<form id="activity" lay-filter="activity" class="layui-form">
				<div class="layui-form-item" style="padding:10px;">
		  			<div class="layui-form-item" >
				        <label class="layui-form-label">活动主题*</label>
				        <div class="layui-input-block">
				            <input id="theme" name="theme" placeholder="请输入活动主题" type="text" class="layui-input" maxlength="64" lay-verify=""/>
				        </div>
				    </div>
				    
		  			<div class="layui-form-item" >
				        <label class="layui-form-label">副主题</label>
				        <div class="layui-input-block">
				            <input id="subtopic" name="subtopic" placeholder="请输入副主题" type="text" class="layui-input" maxlength="64" lay-verify=""/>
				        </div>
				    </div>
				    
		  			<div class="layui-form-item" >
				        <label class="layui-form-label">活动时间</label>
				        <div class="layui-input-block">
				            <input id="activityDate" name="activityDate" placeholder="请输入活动时间" type="text" class="layui-input" maxlength="64" lay-verify=""/>
				        </div>
				    </div>
				    
		  			<div class="layui-form-item" >
				        <label class="layui-form-label">活动地点</label>
				        <div class="layui-input-block">
				            <input id="address" name="address" placeholder="请输入活动地点" type="text" class="layui-input" maxlength="64" lay-verify=""/>
				        </div>
				    </div>
				    <div class="layui-form-item model-form-footer">
				        <button class="layui-btn" lay-filter="activity-form-submit" lay-submit>保存</button>
				    </div>
			    </div>
			    </form>	
			</div>
			
			
			
		    <div class="layui-tab-item">
		    	<form id="activityDetailForm" lay-filter="activityDetail" class="layui-form">
		    	<div class="layui-form-item" style="padding:10px;">
		    		
		  			<div class="layui-form-item" >
		  				<label class="layui-form-label">标题<!-- （若不设置，则不显示详情按钮） --></label>
				        <div class="layui-input-block">
				            <input id="activityTitle" name="activityTitle" placeholder="请输入标题详情" type="text" class="layui-input" maxlength="64" lay-verify=""/>
				        </div>
				    </div>
				    
		  			<div class="layui-form-item" >
				        <label class="layui-form-label">详情</label>
				        <div class="layui-input-block">
				            <textarea id="activity_Detail" onblur="$('#activityDetail').val($('#activity_Detail').val());" name="activity_Detail" placeholder="请输入详情内容" style="height: 100px;" class="layui-input" maxlength="500" lay-verify=""/>
				        </div>
				    </div>
				    
				    <div class="layui-form-item" id="addPhoto">
		  				<label class="layui-form-label"></label>
				    	<div class="layui-input-block" style="padding-top:20px;">
				    		<button type="button" class="layui-btn" id="uploadImg2">
							  <i class="layui-icon">&#xe67c;</i>添加图片
							</button>
						</div>
				    </div>
				    <div class="layui-form-item" style="padding:10px;margin-left: 92px;">
				        <div id="bannerImg">
				        	
				        </div>
				
				    </div>
				    <input id="img1" name="img1" type="hidden">
				    <input id="img2" name="img2" type="hidden">
				    <input id="activityDetail" name="activityDetail" type="hidden">
			    
			    
				    <div class="layui-form-item model-form-footer">
				        <button id="saveHiddenVal" class="layui-btn" lay-filter="activity-detail-form-submit" lay-submit>保存</button>
				    </div>
			    </div>	
			    </form>
			</div>
			
		  </div>
		</div>
		
		<!-- 表格顶部操作列 -->
        <script type="text/html" id="pageClicks-toolbar">
            <div class="layui-btn-container">
                
            </div>
        </script>
    </div>
</div>

<script>

    layui.use(['form', 'config', 'crown', 'flow', 'upload'], function () {
        var table = layui.table;
        var config = layui.config;
        var layer = layui.layer;
        var crown = layui.crown;
        var form = layui.form;
        var $ = layui.jquery;
        var upload = layui.upload;
        layer.closeAll('loading');
        
        var flow = layui.flow, pages=0;
        var uuid = location.hash.split("=")?location.hash.split("=")[1]:null;
        var imgPathArr=[],imgNameArr=[];
      
        //-----------------------------------------------------------------------------
        //banner图片上传,详情图片上传
          var uploadInst = upload.render({
              elem: '#uploadImg2' //绑定元素
              ,url: '/activity/upload' //上传接口
              ,headers: {Authorization: config.getToken()},
              data: {"uuid": null},
  	        accept: "images", //普通文件
  	        exts: 'jpg|png|jpeg|gif',//设置可上传文件
  	        multiple: false, //多文件上传
  	        size:10240,//图片大小10M
           	before: function(obj){
           		 //预读本地文件示例，不支持ie8
                    obj.preview(function(index, files, result) {
                        $('#bannerImg').append('<p style="position: relative;float: left;"><img src="' + result 
                            + '" alt="' + files.name 
                            +'"height="92px" width="92px" style="margin:5px;" class="layui-upload-img uploadImgPreView"><i class="layui-icon layui-table-tips-d layui-icon-close"></i></p>');
                    }); 
                }
              ,done: function(res, index, upload){
              	//console.log(res);
              	imgPathArr.push(res.result.msg.imgInfo.imgPath);
              	imgNameArr.push(res.result.msg.imgInfo.imgName);
                var count = $("#bannerImg").children().length;
      		  //-----------------------------------------------------------------------------
      		 //判断图片数量
      		 // var count = $("#img").length;
      		 
      		  if(count >=2){
      			 
      			  $("#addPhoto").hide();
      		  } else {
      			  $("#addPhoto").show();
      		  }
      		  	
              },error: function(e){
                console.log(e);
                //请求异常回调
              }
            });
          //-----------------------------------------------------------------------------
        //回显基本信息内容
          crown.get('/activity/' + uuid, {async:false}, function (data) {
        	  //console.log(data);
        	  $("#theme").val(data.result.theme);
    		  $("#subtopic").val(data.result.subtopic);
    		  $("#activityDate").val(data.result.activityDate);
    		  $("#address").val(data.result.address);
              
          });
          //-----------------------------------------------------------------------------
          //回显详情内容
          crown.get('/activityDetail/' + uuid, {async:false}, function (data) {
        	  //console.log(data);
        	  $("#activityTitle").val(data.result.activityTitle);
    		  $("#activityDetail").val(data.result.activityDetail);
    		  $("#activity_Detail").val(data.result.activityDetail);
    		  $("#img1").val(data.result.img1);
    		  $("#img2").val(data.result.img2);
    		  //bannerImg
    		  var img1 =data.result.img1?data.result.img1:"";
    		  var img2 =data.result.img2?data.result.img2:"";
    		 
    		  if(img1 !=""){
    		  	$("#bannerImg").append('<p style="position: relative;float: left;"><img src="./image/' + img1
                      +'"height="186px" width="186px" style="margin:5px;"class="img-aa layui-upload-img uploadImgPreView"><i class="layui-icon layui-table-tips-d layui-icon-close"></i></p>');
    		  } 
    		  
			  if(img2 !=""){
    			  $("#bannerImg").append('<p style="position: relative;float: left;"><img src="./image/' + img2
                          +'"height="186px" width="186px" style="margin:5px;"class="img-aa layui-upload-img uploadImgPreView"><i class="layui-icon layui-table-tips-d layui-icon-close"></i></p>');
    		  }
			  
    		  var count = $("#bannerImg").children().length;
    		  //-----------------------------------------------------------------------------
    		 //判断图片数量
    		 // var count = $("#img").length;
    		 
    		  if(count >=2){
    			 
    			  $("#addPhoto").hide();
    		  } else {
    			  $("#addPhoto").show();
    		  }
          });
          //-----------------------------------------------------------------------------
       	  // 活动基本信息表单提交事件
          form.on('submit(activity-form-submit)', function (data) {
              layer.load(2);
              /* console.log(data);
              data.field = {
            		  theme:$("#theme").val(),
            		  subtopic:$("#subtopic").val(),
            		  activityDate:$("#activityDate").val(),
            		  address:$("#address").val(),
              };
               */
              crown.put('/activity/' + uuid, {data: data.field}, function () {
                  layer.closeAll('loading');
                  layer.msg('修改成功', {icon: 1});
              });
              layer.closeAll('loading');
              
              return false;
          });
       
          
		  	$('#saveHiddenVal').click(function () {
		  		if(imgPathArr.length >= 2){
		  			$("#img1").val(imgPathArr[0]);
    			  	$("#img2").val(imgPathArr[1]);
		  		}
		  		
		  	});
          // 活动详情表单提交事件
          form.on('submit(activity-detail-form-submit)', function (data) {
              layer.load(2);
              
              console.log(data);
              crown.put('/activityDetail/' + uuid, {data: data.field}, function () {
                  layer.closeAll('loading');
                  layer.msg('修改成功', {icon: 1});
              });
              layer.closeAll('loading');
              
              return false;
          });
          //-----------------------------------------------------------------------------  
         //封装查询照片数量方法
        function findCount(){
        	 var imgcount= $("#flowContent").children().length-2;
             if(imgcount==0){
            	 $("#delete-button").hide();
             }
          	$("#count-botton").html("全部（"+imgcount+")")
          }
       
		
        
          
        if (uuid != null){
	        flow.load({
	          elem: '#flowContent' //指定列表容器
	          ,scrollElem: '#flowContent' 
	          ,isLazyimg: true
	          ,isAuto: true
	          ,done: function(page, next){ //到达临界点（默认滚动触发），触发下一页
	            var list = [];
          		crown.get('/images', {data:{uuid: uuid, cursor:page}}, function (data) {
                	pages = data.result.pages;
                    data = data.result.records;
                    layui.each(data, function(index, item){
                    	//console.log(item.imgPath);
                    	list.push('<li style="display: inline-block;"><a class="fancybox" href="./image/' + item.imgPath + '" data-fancybox-group="gallery"><img lay-src="./image/' + item.scaleImgPath 
                                + '" alt="' + item.imgName 
                                +'"height="186px" width="186px" style="margin:5px;" class="layui-upload-img uploadImgPreView"></a><div class="bbb"><img data='+item.id+'  class="eee" src="./assets/images/unselected.png"></img></div></li>');
                    }); 
                   //加载更多提升信息
                     $("#flowContent li:last").remove();
                    next(list.join(''), page < pages);
                  
                    if($(".layui-flow-more").children().children().html()=="加载更多"){
                    	$("#flowContent").append('<li style="display: inline-block;">点击下方加载更多·······</li>');
                        
                        var index=   $("#flowContent li:last");
                        index.prev().before(index);
                    } 
                    
                    
                    //显示相片数量
                    if(data==""){
               		 $("#delete-button").css("display","none");
               	}
                    
                 	$("#span-count").html(data[0].count)
                
                }); 
          	
          		
          		
	          }
	        });
	    
	        
	        
	        //-----------------------------------------------------------------------------
	        flow.lazyimg({
	            elem: '#flowContent img'
	            ,scrollElem: '#flowContent' //一般不用设置，此处只是演示需要。
	          });
	        
	      //-----------------------------------------------------------------------------   
	        $(document).ready(function() {
				$('.fancybox').fancybox();
			});
	        
	        //-----------------------------------------------------------------------------    
	        //点击弹出添加图片框
	        $('#addImg').click(function () {
	        	crown.popupCenter({
	                title: '添加照片' ,
	                path: 'components/views/gallery/uploadImg.html',
	                area:'534px',
	                finish: function () {
	                    //userTable.reload('user-table', {});
	                	layer.closeAll('loading');
	                }
	            });
	        });
	      
	        //-----------------------------------------------------------------------------  
	        //删除活动详情图片
	        $('.layui-table-tips-d').click(function (e) {
	        	var src= $(e.target).prev().attr("src");
	        	 $(e.target).parent().html("");
	        	 $("#addPhoto").show();
	        	 //获取图片名字
	        	var imgName = src.substr(src.lastIndexOf("/")).substring(1);
	        	   crown.get("/activityDetail/deleteImg/"+imgName,{data:{}}, function (data) {
	               });
	        });
	        //-----------------------------------------------------------------------------   
	       //详情图片鼠标悬停事件
	        $(".img-aa").hover(function(e){  
	        	$(e.target).next().show();
	        },function(e){  
	        	$(e.target).next().hide();
	        });
	        //-----------------------------------------------------------------------------
	        //删除按钮悬停事件
	         $(".layui-table-tips-d").hover(function(e){  
	        	$(e.target).show();
	        },function(e){  
	        	$(e.target).hide();
	        });
	         //-----------------------------------------------------------------------------    
	         //删除照片显示勾框
	         $("#delete-button").click(function(){
	        	 $("#cancel-button").css("display","block");
	        	 $("#yes-botton").css("display","block");
	        	 $("#all-botton").css("display","block");
	        	$(".bbb").css("display","block");
	        	 $("#delete-button").hide();
	         })
	          //-----------------------------------------------------------------------------
	         //全选点击事件
	         $("#all-botton").click(function(){
	        	 $("#all-botton").css("display","none");
	        	 $("#notAll-botton").css("display","block");
	        	 $("#yes-botton").css("display","none");
	        	 $("#yesall-botton").css("display","block");
	        	 $(".eee").attr('src','./assets/images/selected.png')
	          //-----------------------------------------------------------------------------	 
	        	 
	         })
	         //取消全选
	         $("#notAll-botton").click(function(){
	        	 $("#yes-botton").css("display","block");
	        	 $("#yesall-botton").css("display","none");
	        	 $("#all-botton").css("display","block");
	        	 $("#notAll-botton").css("display","none");
	        	 $(".eee").attr('src','./assets/images/unselected.png')
	         })
	         //-----------------------------------------------------------------------------
	         //选择照片变换状态
	    /*      $('body').on('click','.layui-upload-img',function(e){
	        	if($("#delete-button").css("display")=="none"){
	        		
	        		 if($(e.target).next().children().attr('src')=='./assets/images/unselected.png'){
	 	 				$(e.target).next().children().attr('src','./assets/images/selected.png');
	 	 			}else{
	 	 				$(e.target).next().children().attr('src','./assets/images/unselected.png');
	 	 			}
	        	}
	         }); */
	         //------------------------------------------------------------------------------
	         //小图标选择改变状态
	         $('body').on('click','.eee',function(e){
	        	 if($(e.target).attr('src')=='./assets/images/unselected.png'){
	 				$(e.target).attr('src','./assets/images/selected.png');
	 			}else{
	 				$(e.target).attr('src','./assets/images/unselected.png');
	 			}
	         });
	         //---------------------------------------------------------------------------
	         
	         //点击取消按钮，取消删除
 				$("#cancel-button").click(function(){
 					 $("#yesall-botton").css("display","none");
	        	 $("#cancel-button").css("display","none");
	        	 $("#yes-botton").css("display","none");
	        	 $("#all-botton").css("display","none");
		        $("#notAll-botton").css("display","none");
	        	$(".bbb").css("display","none");
	        	 $("#delete-button").show();
	        	 $(".eee").attr('src','./assets/images/unselected.png')
	         })
	         //--------------------------------------------------------------------------
	         //点击确定按钮，确定删除
 				$("#yes-botton").click(function(){
 					
 					var srcArray = [];
	  					 $(".eee").each(function(){
	  						var src = this.src;
	  					var imgsrc = src.substr(src.lastIndexOf("/")).substring(1);
	  						if(imgsrc=="selected.png"){
	  							var id = $(this).attr("data");
	  							$(this).parent().parent().remove();
	  							srcArray.push(id);
	  						}
	  					 })
	  					 if(srcArray==""){
	  						 alert("请选择照片！");
	  					 }else{
	  						$(".bbb").css("display","none");
	  						 $("#all-botton").css("display","none");
	  			        	 $("#notAll-botton").css("display","none");
	  						 $("#cancel-button").css("display","none");
	  			        	 $("#yes-botton").css("display","none");
	  			        	 $("#delete-button").show();
	  						 crown.get("/activity/deleteSelectedImgs?ids="+srcArray,{data:{}}, function (data) {
	  			                  console.log(data);
	  			               });
	  					 }

	  					 //修改照片数量
	  					var oldCount=$("#span-count").html();
            	var newCount=parseInt(oldCount)-srcArray.length;
            	if(newCount==0){
            		 $("#delete-button").css("display","none");
            	}
              	$("#span-count").html(newCount)
	         })
	         //-----------------------------------------------------------------
	        	$("#yesall-botton").click(function(){
	        		 $("#all-botton").css("display","none");
			        	 $("#notAll-botton").css("display","none");
						 $("#cancel-button").css("display","none");
			        	 $("#yes-botton").css("display","none");
			        	 $("#yesall-botton").css("display","none");
			        	$("#addImg").siblings().remove();
			        	$("#span-count").html(0);
			        	 crown.get("/activity/deleteAllImgs?uuId="+uuid,{data:{}}, function (data) {
 			                  console.log(data);
 			               });
	         })
        }
    });
</script>